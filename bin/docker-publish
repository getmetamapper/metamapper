#!/bin/bash
set -e

docker login -u $DOCKER_USER -p $DOCKER_PASS

if [[ $CIRCLE_BRANCH = master ]]
then
    VERSION_TAG="${CIRCLE_SHA1:0:6}"

    docker build --build-arg env=production -t metamapper/preview:$VERSION_TAG .

    docker push metamapper/preview:$VERSION_TAG
    echo "Pushed: metamapper/preview:$VERSION_TAG"
else
    VERSION=$(python -c "from metamapper import __version__; print(__version__)")
    VERSION_TAG="v$VERSION"

    if [ -z "$1" ]; then
        echo "Please provided the current expected version."
        exit 1
    fi

    # Check if the current version matches the expected version
    if [ $VERSION != "$1" ]; then
        echo "Provided version ($1) does not match current version. Update it in the Metamapper configuration."
        exit 1
    fi

    docker build --build-arg env=production -t metamapper/metamapper:$VERSION .

    docker push metamapper/metamapper:$VERSION
    echo "Pushed: metamapper/metamapper:$VERSION"

    docker tag metamapper/metamapper:$VERSION metamapper/metamapper:latest

    docker push metamapper/metamapper:latest
    echo "Pushed: metamapper/metamapper:latest"
fi
